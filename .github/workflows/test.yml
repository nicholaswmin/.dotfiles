name: Test Dotfiles Generator

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  HOMEBREW_NO_ANALYTICS: 1
  HOMEBREW_NO_AUTO_UPDATE: 1

jobs:
  test:
    name: Test on macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Validate generator script
      run: |
        zsh -n make.zsh
        chmod +x make.zsh
        echo "✓ Generator script validation passed"
        
    - name: Run generator
      run: |
        ./make.zsh
        echo "✓ Generator execution completed"
        
    - name: Run test suite
      run: |
        ls -la
        ./tests/run-all.sh
        
    - name: Validate generated structure
      run: |
        test -f dotfiles || (echo "❌ Main executable missing" && exit 1)
        test -f install.sh || (echo "❌ Install script missing" && exit 1)
        test -f README.md || (echo "❌ Documentation missing" && exit 1)
        test -d _lib || (echo "❌ Library directory missing" && exit 1)
        test -d tests || (echo "❌ Tests directory missing" && exit 1)
        
        test -x dotfiles || (echo "❌ Main executable not executable" && exit 1)
        test -x install.sh || (echo "❌ Install script not executable" && exit 1)
        
        echo "✓ Generated structure validation passed"
        
    - name: Test CLI help system
      run: |
        ./dotfiles --help >/dev/null || (echo "❌ Help command failed" && exit 1)
        ./dotfiles --version >/dev/null || (echo "❌ Version command failed" && exit 1)
        
        echo "✓ CLI help system validation passed"
